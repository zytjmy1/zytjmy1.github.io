<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿåˆ»æ±‰é£ï¼šå½­åŸå¥‡é‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f1e9;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23e0dace' fill-opacity='0.4'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v5h-1v-5h-9v5h-1v-5h-9v5h-1v-5h-9v5h-1v-5h-9v5h-1v-5h-9v5H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5V0h1z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .game-title {
            font-family: 'ZCOOL KuaiLe', cursive;
        }
        .symbol-item-container {
            position: relative;
        }
        .symbol-item {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            will-change: transform;
        }
        .symbol-item.popping {
            animation: pop 0.3s ease-out;
        }
        @keyframes pop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .revenue-float {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 215, 0, 0.95);
            color: #333;
            padding: 1px 5px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            animation: floatUp 0.8s ease-out forwards;
            white-space: nowrap;
        }
        @keyframes floatUp {
            from {
                opacity: 0;
                transform: translate(-50%, 10px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -12px);
            }
        }
        .choice-card {
             transition: transform 0.2s, box-shadow 0.2s;
        }
        .choice-card:hover:not(.disabled) {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .choice-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="game-container" class="w-full max-w-lg mx-auto bg-white/70 backdrop-blur-sm rounded-2xl shadow-2xl p-6 text-gray-800 border-4 border-amber-800/50 relative">

        <header class="text-center mb-4">
            <h1 class="game-title text-4xl text-amber-900">é£Ÿåˆ»æ±‰é£</h1>
            <p class="text-amber-800/80">å½­åŸå¥‡é‡</p>
        </header>

        <div class="flex justify-between items-start mb-4">
             <div id="info-panel" class="grid grid-cols-3 gap-2 text-center bg-amber-100/50 p-2 rounded-lg flex-grow">
                <div>
                    <div class="text-xs text-amber-700">å¤©æ•°</div>
                    <div id="day-counter" class="text-xl font-bold text-amber-900">1</div>
                </div>
                <div>
                    <div class="text-xs text-amber-700">å‰©ä½™ç‚‰æ•°</div>
                    <div id="spins-left" class="text-xl font-bold text-amber-900">5</div>
                </div>
                <div>
                    <div class="text-xs text-amber-700">è¥ä¸šé¢ (ç›®æ ‡)</div>
                    <div id="revenue-display" class="text-xl font-bold text-amber-900">Â¥0 / 40</div>
                </div>
            </div>
             <div id="perks-display" class="flex flex-col items-start ml-2 p-2 bg-green-100/50 rounded-lg w-24">
                <div class="text-xs text-green-800 font-bold w-full text-center mb-1">å…¨å±€å¢ç›Š</div>
                <div id="perks-list" class="flex flex-wrap gap-1 justify-center"></div>
            </div>
        </div>
        
        <main id="grill-grid" class="grid grid-cols-5 gap-2 mb-4 h-48 bg-gray-700/80 p-3 rounded-lg shadow-inner">
            <!-- Symbols will be dynamically inserted here -->
        </main>

        <div id="message-box" class="text-center h-6 mb-2 font-bold text-green-600 transition-opacity duration-300"></div>

        <div id="controls" class="flex flex-col items-center">
            <button id="spin-button" class="game-title w-full bg-amber-600 text-white text-2xl py-3 rounded-lg shadow-lg hover:bg-amber-700 active:bg-amber-800 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed">å¼€ä¸€ç‚‰ (Â¥1)</button>
        </div>

        <!-- Modals -->
        <div id="modal-container" class="hidden absolute inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-10">
            <div id="modal-content" class="bg-amber-50 max-w-lg w-full rounded-xl p-6 text-center shadow-2xl">
                 <!-- Content will be injected here -->
            </div>
        </div>
        
        <!-- Rules Modal -->
        <div id="rules-modal" class="absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-20">
            <div class="bg-amber-50 max-w-lg w-full rounded-xl p-8 text-left shadow-2xl">
                <h2 class="game-title text-3xl text-amber-800 mb-4 text-center">æ¸¸æˆè§„åˆ™</h2>
                <ul class="list-disc list-inside space-y-2 text-gray-700">
                    <li><strong>æ¸¸æˆç›®æ ‡ï¼š</strong>åœ¨â€œå‰©ä½™ç‚‰æ•°â€ç”¨å®Œå‰ï¼Œè¾¾åˆ°æ¯æ—¥çš„â€œè¥ä¸šé¢â€ç›®æ ‡ã€‚</li>
                    <li><strong>æ ¸å¿ƒæ“ä½œï¼š</strong>ç‚¹å‡»ã€å¼€ä¸€ç‚‰ã€‘æŒ‰é’®ï¼Œä¼šåœ¨çƒ¤æ¶ä¸Šéšæœºå‡ºç°è‹¥å¹²ç‰©å“ã€‚</li>
                    <li><strong>è·å¾—æ”¶ç›Šï¼š</strong>çƒ¤æ¶ä¸Šçš„ç‰©å“ä¼šæ ¹æ®è‡ªèº«ä»·å€¼å’Œç›¸é‚»ç‰©å“çš„â€œååŒæ•ˆåº”â€äº§ç”Ÿæ”¶ç›Šã€‚</li>
                    <li><strong>é€‰æ‹©é“å…·ï¼š</strong>æ¯å¼€ä¸€ç‚‰åï¼Œä½ éƒ½å¯ä»¥ä»éšæœºå‡ºç°çš„ä¸‰ä¸ªé€‰é¡¹ä¸­ï¼ŒèŠ±è´¹é‡‘å¸è´­ä¹°ä¸€ä¸ªæ–°â€œç‰©å“â€æˆ–æ°¸ä¹…â€œå¢ç›Šâ€ã€‚</li>
                    <li><strong>ä¸æ–­æˆé•¿ï¼š</strong>æ˜æ™ºåœ°é€‰æ‹©é“å…·ï¼Œæ„ç­‘å¼ºå¤§çš„ç»„åˆï¼ŒæŒ‘æˆ˜æ›´é«˜çš„è¥ä¸šé¢ï¼Œæˆä¸ºå½­åŸçƒ¤ä¸²ç‹ï¼</li>
                </ul>
                <button id="start-game-button" class="game-title w-full mt-6 bg-green-600 text-white text-2xl py-3 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-200">å¼€å§‹å¤§å‰</button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const dayCounter = document.getElementById('day-counter');
            const spinsLeftDisplay = document.getElementById('spins-left');
            const revenueDisplay = document.getElementById('revenue-display');
            const grillGrid = document.getElementById('grill-grid');
            const messageBox = document.getElementById('message-box');
            const spinButton = document.getElementById('spin-button');
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            const perksList = document.getElementById('perks-list');
            const rulesModal = document.getElementById('rules-modal');
            const startGameButton = document.getElementById('start-game-button');

            // --- DATA DEFINITIONS ---
            const SYMBOLS = {
                yangrou: { id: 'yangrou', name: 'ç¾Šè‚‰ä¸²', emoji: 'ğŸ¢', type: 'ç‰©å“', itemType: 'è‚‰ç±»', baseValue: 3, rarity: 1, cost: 0, description: 'åŸºç¡€è‚‰ç±»ï¼Œä»·å€¼+3ã€‚' },
                jiucai: { id: 'jiucai', name: 'éŸ­èœ', emoji: 'ğŸ¥¬', type: 'ç‰©å“', itemType: 'ç´ èœ', baseValue: 2, rarity: 1, cost: 0, description: 'åŸºç¡€ç´ èœï¼Œä»·å€¼+2ã€‚' },
                wuhuarou: { id: 'wuhuarou', name: 'äº”èŠ±è‚‰', emoji: 'ğŸ¥“', type: 'ç‰©å“', itemType: 'è‚‰ç±»', baseValue: 4, rarity: 2, cost: 0, description: 'ä¼˜è´¨è‚‰ç±»ï¼Œä»·å€¼+4ã€‚' },
                jinzhengu: { id: 'jinzhengu', name: 'é‡‘é’ˆè‡', emoji: 'ğŸ„', type: 'ç‰©å“', itemType: 'ç´ èœ', baseValue: 3, rarity: 2, cost: 0, description: 'ä¼˜è´¨ç´ èœï¼Œä»·å€¼+3ã€‚' },
                kaohu: { id: 'kaohu', name: 'çƒ¤ç³Šçš„ä¸²', emoji: 'ğŸ”¥', type: 'ç‰©å“', itemType: 'è´Ÿé¢', baseValue: 0, rarity: 2, cost: 0, description: 'æ•ˆæœï¼šéšæœºæ‘§æ¯ä¸€ä¸ªç›¸é‚»çš„ç‰©å“ã€‚', 
                    effect: (grid, index) => {
                        const neighbors = getNeighbors(index);
                        if (neighbors.length > 0) {
                            const victimIndex = neighbors[Math.floor(Math.random() * neighbors.length)];
                            if(grid[victimIndex]) {
                                grid[victimIndex] = null;
                            }
                        }
                        return 0;
                    }
                },
                jichi: { id: 'jichi', name: 'é¸¡ç¿…', emoji: 'ğŸ—', type: 'ç‰©å“', itemType: 'è‚‰ç±»', baseValue: 5, rarity: 3, cost: 1, description: 'é«˜çº§è‚‰ç±»ï¼Œä»·å€¼+5ã€‚' },
                qianzi: { id: 'qianzi', name: 'ç­¾å­', emoji: 'ğŸ¥¢', type: 'ç‰©å“', itemType: 'å·¥å…·', baseValue: 1, rarity: 3, cost: 1, description: 'æ•ˆæœï¼šæ¯æœ‰ä¸€ä¸ªç­¾å­ï¼Œæ‰€æœ‰ç­¾å­ä»·å€¼éƒ½å¢åŠ ã€‚',
                    synergy: (grid, index) => {
                        const count = grid.filter(s => s && s.id === 'qianzi').length;
                        return count > 1 ? (count * count - count) : 0;
                    }
                },
                ziran: { id: 'ziran', name: 'å­œç„¶', emoji: 'âœ¨', type: 'ç‰©å“', itemType: 'ä½æ–™', baseValue: 1, rarity: 3, cost: 1, description: 'æ•ˆæœï¼šä½¿æ‰€æœ‰ç›¸é‚»çš„è‚‰ç±»ä»·å€¼ç¿»å€ã€‚',
                    synergy: (grid, index) => {
                        let bonus = 0;
                        getNeighbors(index).forEach(nIndex => {
                            if (grid[nIndex] && grid[nIndex].itemType === 'è‚‰ç±»') {
                                bonus += grid[nIndex].baseValue;
                            }
                        });
                        return bonus;
                    }
                },
                lajiao: { id: 'lajiao', name: 'è¾£æ¤’ç²‰', emoji: 'ğŸŒ¶ï¸', type: 'ç‰©å“', itemType: 'ä½æ–™', baseValue: 1, rarity: 4, cost: 1, description: 'æ•ˆæœï¼šçƒ¤æ¶ä¸Šæ¯æœ‰ä¸€ä¸ªç‰©å“ï¼Œå°±+1é‡‘å¸ã€‚',
                    synergy: (grid, index) => grid.filter(s => s).length -1
                },
                dauan: { id: 'dauan', name: 'å¤§è’œ', emoji: 'ğŸ§„', type: 'ç‰©å“', itemType: 'ä½æ–™', baseValue: 1, rarity: 4, cost: 1, description: 'æ•ˆæœï¼šæ¯ä¸ªç›¸é‚»çš„ç´ èœï¼Œ+5é‡‘å¸ã€‚',
                    synergy: (grid, index) => {
                        let bonus = 0;
                        getNeighbors(index).forEach(nIndex => {
                            if (grid[nIndex] && grid[nIndex].itemType === 'ç´ èœ') bonus += 5;
                        });
                        return bonus;
                    }
                },
                zhutan: {id: 'zhutan', name: 'ç«¹ç‚­', emoji: 'âš«', type: 'ç‰©å“', itemType: 'å·¥å…·', baseValue: 0, rarity: 4, cost: 1, description: 'æ•ˆæœï¼šç§»é™¤æ‰€æœ‰çƒ¤ç³Šçš„ä¸²ï¼Œæ¯ä¸ª+3é‡‘å¸ã€‚',
                    effect: (grid, index) => {
                        let removedCount = 0;
                        grid.forEach((symbol, i) => {
                            if(symbol && symbol.id === 'kaohu'){
                                grid[i] = null;
                                removedCount++;
                            }
                        });
                        return removedCount * 3;
                    }
                },
                fazhan: { id: 'fazhan', name: 'å‘ç°ª', emoji: 'ç°ª', type: 'ç‰©å“', itemType: 'æ±‰æœ', baseValue: 5, rarity: 4, cost: 1, description: 'æ•ˆæœï¼šä¸å¦ä¸€ä»¶æ±‰æœç›¸é‚»æ—¶ï¼Œå½¼æ­¤éƒ½+10é‡‘å¸ã€‚',
                    synergy: (grid, index) => {
                        let bonus = 0;
                        getNeighbors(index).forEach(nIndex => {
                            if (grid[nIndex] && grid[nIndex].itemType === 'æ±‰æœ') bonus += 10;
                        });
                        return bonus;
                    }
                },
                fengshan: { id: 'fengshan', name: 'å°é£æ‰‡', emoji: 'ğŸ’¨', type: 'ç‰©å“', itemType: 'å·¥å…·', baseValue: 0, rarity: 5, cost: 2, description: 'æ•ˆæœï¼šæœ¬ç‚‰æ‰€æœ‰äº§å‡ºä»·å€¼ç¿»å€ã€‚',
                    effect: (grid, index) => 'double'
                },
                yupei: { id: 'yupei', name: 'ç‰ä½©', emoji: 'ç‰', type: 'ç‰©å“', itemType: 'æ±‰æœ', baseValue: 4, rarity: 5, cost: 2, description: 'æ•ˆæœï¼šæ¯ä¸ªç›¸é‚»çš„ç‰©å“ï¼ŒåŸºç¡€ä»·å€¼+2ã€‚',
                     synergy: (grid, index) => getNeighbors(index).filter(nIndex => grid[nIndex]).length * 2
                },
                xiangnang: { id: 'xiangnang', name: 'é¦™å›Š', emoji: 'é¦™', type: 'ç‰©å“', itemType: 'æ±‰æœ', baseValue: 0, rarity: 5, cost: 2, description: 'æ•ˆæœï¼šå‡ºç°æ—¶ï¼Œå› å…¶é¦™æ°”å¸å¼•é¡¾å®¢ï¼Œç›´æ¥äº§ç”Ÿ+5é‡‘å¸ã€‚',
                    effect: (grid, index) => 5
                },
                laomo: { id: 'laomo', name: 'çƒ™é¦', emoji: 'ğŸ«“', type: 'ç‰©å“', itemType: 'å¾å·ç‰¹è‰²', baseValue: 5, rarity: 6, cost: 2, description: 'æ•ˆæœï¼šå·èµ°çƒ¤æ¶ä¸Šçš„ä¸€åˆ‡ï¼Œå¹¶ä½¿å…¶ä»·å€¼ç¿»å€ï¼',
                    effect: (grid, index) => {
                        let totalValue = 0;
                        grid.forEach((symbol, i) => {
                            if (symbol && i !== index) {
                                totalValue += symbol.baseValue;
                                grid[i] = null;
                            }
                        });
                        return totalValue * 2;
                    }
                },
                quju: { id: 'quju', name: 'æ›²è£¾', emoji: 'ğŸ‘˜', type: 'ç‰©å“', itemType: 'æ±‰æœ', baseValue: 8, rarity: 6, cost: 2, description: 'æ•ˆæœï¼šæ¯ä¸ªç›¸é‚»çš„æ±‰æ–‡åŒ–ç‰©å“ï¼Œ+25é‡‘å¸ã€‚',
                    synergy: (grid, index) => {
                        let bonus = 0;
                        getNeighbors(index).forEach(nIndex => {
                            if (grid[nIndex] && grid[nIndex].itemType === 'æ±‰æ–‡åŒ–') bonus += 25;
                        });
                        return bonus;
                    }
                },
                daxiushan: { id: 'daxiushan', name: 'å¤§è¢–è¡«', emoji: 'è¡«', type: 'ç‰©å“', itemType: 'æ±‰æœ', baseValue: 2, rarity: 7, cost: 2, description: 'æ•ˆæœï¼šæŒ¥åŠ¨å¤§è¢–ï¼Œæ‰«æ¸…åŒè¡Œçš„æ‰€æœ‰ç‰©å“ï¼Œæ¯ä¸ª+3é‡‘å¸ã€‚',
                    effect: (grid, index) => {
                        let clearedCount = 0;
                        const row = Math.floor(index / 5);
                        for (let i = row * 5; i < (row + 1) * 5; i++) {
                            if (i !== index && grid[i]) {
                                clearedCount++;
                                grid[i] = null;
                            }
                        }
                        return clearedCount * 3;
                    }
                },
                hanhuashi: { id: 'hanhuashi', name: 'æ±‰ç”»åƒçŸ³', emoji: 'ğŸ—¿', type: 'ç‰©å“', itemType: 'æ±‰æ–‡åŒ–', baseValue: 10, rarity: 7, cost: 2, description: 'æ•ˆæœï¼šå¤åˆ¶ä¸€ä¸ªç›¸é‚»çš„ç‰©å“ã€‚',
                    effect: (grid, index) => {
                        let bestNeighbor = null;
                        let maxVal = -1;
                        getNeighbors(index).forEach(nIndex => {
                            if (grid[nIndex] && grid[nIndex].baseValue > maxVal) {
                                maxVal = grid[nIndex].baseValue;
                                bestNeighbor = grid[nIndex];
                            }
                        });
                        if (bestNeighbor) {
                            const emptySlot = grid.findIndex(s => s === null);
                            if (emptySlot !== -1) grid[emptySlot] = { ...bestNeighbor };
                        }
                        return 0;
                    }
                },
                tuopian: { id: 'tuopian', name: 'æ‹“ç‰‡', emoji: 'çº¸', type: 'ç‰©å“', itemType: 'æ±‰æ–‡åŒ–', baseValue: 1, rarity: 5, cost: 1, description: 'æ•ˆæœï¼šä¸æ±‰ç”»åƒçŸ³ç›¸é‚»æ—¶ï¼Œè·å¾—å…¶åŸºç¡€ä»·å€¼ï¼Œå¹¶æœ‰å‡ ç‡è·å¾—ä¸€ä¸ªéšæœºåŸºç¡€ç‰©å“ã€‚',
                    synergy: (grid, index) => {
                        let bonus = 0;
                        getNeighbors(index).forEach(nIndex => {
                            if (grid[nIndex] && grid[nIndex].id === 'hanhuashi') {
                                bonus += grid[nIndex].baseValue;
                                if (Math.random() < 0.5) {
                                    const emptySlot = grid.findIndex(s => s === null);
                                    if (emptySlot !== -1) grid[emptySlot] = { ...SYMBOLS.yangrou };
                                }
                            }
                        });
                        return bonus;
                    }
                }
            };

            const PERKS = {
                 caidan: {id: 'caidan', name: 'èœå•', emoji: 'ğŸ“œ', type: 'å¢ç›Š', cost: 2, description: 'æ•ˆæœï¼šæ°¸ä¹…æ€§ï¼Œæ¯æ¬¡è¿›è´§æ—¶ï¼Œé€‰é¡¹+1ã€‚'},
                 xiaoshuazi: {id: 'xiaoshuazi', name: 'å°åˆ·å­', emoji: 'ğŸ–Œï¸', type: 'å¢ç›Š', cost: 2, description: 'æ•ˆæœï¼šæ°¸ä¹…æ€§ï¼Œæœ‰33%å‡ ç‡å°†çƒ¤ç³Šçš„ä¸²å˜ä¸ºéŸ­èœã€‚'},
                 roushizhuyi: {id: 'roushizhuyi', name: 'è‚‰é£Ÿä¸»ä¹‰', emoji: 'ğŸ–', type: 'å¢ç›Š', cost: 1, description: 'æ•ˆæœï¼šæ°¸ä¹…æ€§ï¼Œæ‰€æœ‰è‚‰ç±»åŸºç¡€ä»·å€¼+1ã€‚'},
                 sushiaihaozhe: {id: 'sushiaihaozhe', name: 'ç´ é£Ÿçˆ±å¥½è€…', emoji: 'ğŸ¥•', type: 'å¢ç›Š', cost: 1, description: 'æ•ˆæœï¼šæ°¸ä¹…æ€§ï¼Œæ‰€æœ‰ç´ èœåŸºç¡€ä»·å€¼+2ã€‚'},
                 chengbenjieyue: {id: 'chengbenjieyue', name: 'æˆæœ¬èŠ‚çº¦', emoji: 'ğŸ’°', type: 'å¢ç›Š', cost: 2, description: 'æ•ˆæœï¼šæ°¸ä¹…æ€§ï¼Œæ¯æ¬¡å¼€ç‚‰è´¹ç”¨-1ï¼ˆæœ€ä½ä¸º0ï¼‰ã€‚'},
                 guishantongtu: {id: 'guishantongtu', name: 'é¾Ÿå±±é€šé€”', emoji: 'éš§', type: 'å¢ç›Š', cost: 2, description: 'æ•ˆæœï¼šæ°¸ä¹…æ€§ï¼Œè¿æ¥çƒ¤æ¶æœ€å·¦ä¾§å’Œæœ€å³ä¾§çš„æ ¼å­ï¼Œä½¿å®ƒä»¬è§†ä¸ºç›¸é‚»ã€‚'}
            }

            let gameState = {};

            function initGame() {
                gameState = {
                    day: 1,
                    spins: 5, 
                    revenue: 0,
                    goal: 40,
                    spinCost: 1,
                    playerSymbols: ['yangrou', 'jiucai'], 
                    gridSize: 15,
                    isGameOver: false,
                    activePerks: [],
                };
                updateUI();
                spinButton.disabled = false;
                grillGrid.innerHTML = '';
            }
            
            function startGame() {
                rulesModal.classList.add('hidden');
                initGame();
                modalContainer.classList.add('hidden');
            }

            function startNextDay() {
                gameState.day++;
                gameState.spins = 5 + (gameState.day - 1);
                gameState.revenue = 0;
                gameState.goal = Math.floor(gameState.goal * 1.7); 
                modalContainer.classList.add('hidden');
                spinButton.disabled = false;
                grillGrid.innerHTML = '';
                updateUI();
            }
            
            function getNeighbors(index) {
                const neighbors = [];
                const cols = 5;
                const rows = 3;
                const row = Math.floor(index / cols);
                const col = index % cols;

                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        if (i === 0 && j === 0) continue;
                        let newRow = row + i;
                        let newCol = col + j;

                        if (gameState.activePerks.find(p => p.id === 'guishantongtu')) {
                            if (newCol < 0) newCol = cols - 1;
                            if (newCol >= cols) newCol = 0;
                        }

                        if (newRow >= 0 && newRow < rows && newCol >= 0 && newCol < cols) {
                            neighbors.push(newRow * cols + newCol);
                        }
                    }
                }
                return neighbors;
            }

            function handleSpin() {
                if (gameState.isGameOver || gameState.spins <= 0) return;
                
                spinButton.disabled = true;
                
                const currentSpinCost = Math.max(0, gameState.spinCost - (gameState.activePerks.find(p => p.id === 'chengbenjieyue') ? 1 : 0));
                gameState.revenue -= currentSpinCost;
                gameState.spins--;
                
                const currentGridSymbols = Array(gameState.gridSize).fill(null);
                const numItemsToSpawn = 3 + Math.floor(Math.random() * 4); 
                const availableSlots = Array.from(Array(gameState.gridSize).keys());

                const weightedSymbolPool = gameState.playerSymbols.flatMap(id => {
                    const rarity = SYMBOLS[id].rarity;
                    const weight = Math.pow(1 / rarity, 2);
                    return Array(Math.ceil(100 * weight)).fill(id);
                });

                for (let i = 0; i < numItemsToSpawn; i++) {
                    if (availableSlots.length === 0) break;
                    const randomSlotIndex = Math.floor(Math.random() * availableSlots.length);
                    const slotToFill = availableSlots.splice(randomSlotIndex, 1)[0];
                    let randomId = weightedSymbolPool[Math.floor(Math.random() * weightedSymbolPool.length)];
                    if (randomId === 'kaohu' && gameState.activePerks.find(p => p.id === 'xiaoshuazi') && Math.random() < 0.33) {
                        randomId = 'jiucai';
                        showMessage('ğŸ–Œï¸ å°åˆ·å­æ˜¾çµäº†ï¼', 'good');
                    }
                    currentGridSymbols[slotToFill] = { ...SYMBOLS[randomId] };
                }

                const { totalRevenue, valueGrid } = calculateRevenue(currentGridSymbols);
                gameState.revenue += totalRevenue;
                
                updateGridDisplay(currentGridSymbols, valueGrid);
                messageBox.textContent = `æœ¬ç‚‰æ€»è®¡: +${Math.round(totalRevenue)}`;
                updateUI();
                
                setTimeout(showItemSelection, 1500);
            }
            
            function calculateRevenue(grid) {
                let tempGrid = [...grid];
                let valueGrid = Array(gameState.gridSize).fill(0);
                let finalMultiplier = 1;

                tempGrid.forEach((symbol, index) => {
                    if (symbol && symbol.effect) {
                        const effectResult = symbol.effect(tempGrid, index);
                        if(effectResult === 'double') {
                            finalMultiplier *= 2;
                        } else if (typeof effectResult === 'number') {
                            valueGrid[index] += effectResult;
                        }
                    }
                });

                tempGrid.forEach((symbol, index) => {
                    if (symbol) {
                        let value = symbol.baseValue;
                        if(symbol.itemType === 'è‚‰ç±»' && gameState.activePerks.find(p => p.id === 'roushizhuyi')) value += 1;
                        if(symbol.itemType === 'ç´ èœ' && gameState.activePerks.find(p => p.id === 'sushiaihaozhe')) value += 2;
                        valueGrid[index] += value;
                    }
                });

                tempGrid.forEach((symbol, index) => {
                    if (symbol && symbol.synergy) {
                        valueGrid[index] += symbol.synergy(tempGrid, index);
                    }
                });
                
                let totalRevenue = 0;
                valueGrid.forEach((value, index) => {
                    const finalValue = Math.round(value * finalMultiplier);
                    valueGrid[index] = finalValue;
                    totalRevenue += finalValue;
                });
                
                return { totalRevenue, valueGrid };
            }

            function updateGridDisplay(symbols, values) {
                 grillGrid.innerHTML = '';
                 symbols.forEach((symbol, index) => {
                    const cellContainer = document.createElement('div');
                    cellContainer.className = 'symbol-item-container bg-amber-200/50 rounded-lg flex items-center justify-center';
                    
                    if (symbol) {
                        cellContainer.innerHTML = `<div class="symbol-item text-4xl popping">${symbol.emoji}</div>`;
                        if (values[index] > 0) {
                            const valueDiv = document.createElement('div');
                            valueDiv.className = 'revenue-float';
                            valueDiv.textContent = `+${values[index]}`;
                            cellContainer.appendChild(valueDiv);
                        }
                    }
                    grillGrid.appendChild(cellContainer);
                });
            }

            function endDay() {
                modalContainer.classList.remove('hidden');
                let contentHTML = '';
                if (gameState.revenue >= gameState.goal) {
                    contentHTML = `
                        <h2 class="game-title text-4xl text-green-600 mb-2">ä»Šæ—¥å¤§å–ï¼</h2>
                        <p class="text-gray-600 mb-6">æˆåŠŸå®Œæˆ Â¥${gameState.goal} çš„è¥ä¸šç›®æ ‡ï¼</p>
                        <button id="next-day-button" class="game-title w-full bg-amber-600 text-white text-2xl py-3 rounded-lg shadow-lg hover:bg-amber-700 transition-all duration-200">è¿æ¥ä¸‹ä¸€å¤©</button>
                    `;
                    modalContent.innerHTML = contentHTML;
                    document.getElementById('next-day-button').addEventListener('click', startNextDay);
                } else {
                    gameState.isGameOver = true;
                    contentHTML = `
                        <h2 class="game-title text-4xl text-red-700 mb-2">ä»Šæ—¥å€’é—­ï¼</h2>
                        <p class="text-gray-600 mb-6">å¯æƒœï¼Œæ²¡èƒ½å®Œæˆ Â¥${gameState.goal} çš„è¥ä¸šç›®æ ‡...</p>
                        <button id="restart-button" class="game-title w-full bg-amber-600 text-white text-2xl py-3 rounded-lg shadow-lg hover:bg-amber-700 transition-all duration-200">ä¸œå±±å†èµ·</button>
                    `;
                    modalContent.innerHTML = contentHTML;
                    document.getElementById('restart-button').addEventListener('click', startGame);
                }
            }

            function showItemSelection() {
                modalContainer.classList.remove('hidden');
                let choicesHTML = '';
                const allItems = {...SYMBOLS, ...PERKS};
                const availableChoices = Object.keys(allItems).filter(id => {
                    const item = allItems[id];
                    if (item.type === 'å¢ç›Š' && gameState.activePerks.find(p => p.id === id)) {
                        return false;
                    }
                    return true;
                });

                if (availableChoices.length === 0) {
                    showMessage('ä½ å·²ç»è§£é”äº†æ‰€æœ‰å¥½ä¸œè¥¿ï¼', 'good');
                    modalContainer.classList.add('hidden');
                    if (gameState.spins <= 0) endDay();
                    else spinButton.disabled = false;
                    return;
                }
                
                const choiceCount = gameState.activePerks.find(p => p.id === 'caidan') ? 4 : 3;
                const choices = [];
                while(choices.length < choiceCount && availableChoices.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableChoices.length);
                    choices.push(availableChoices.splice(randomIndex, 1)[0]);
                }

                choices.forEach(id => {
                    const item = allItems[id];
                    const canAfford = gameState.revenue >= item.cost;
                    const disabledClass = canAfford ? '' : 'disabled';
                    choicesHTML += `
                        <div class="choice-card bg-white p-3 rounded-lg shadow-lg transition-all duration-200 text-center ${disabledClass}" data-id="${id}">
                            <div class="text-5xl mb-2">${item.emoji}</div>
                            <h3 class="font-bold text-base text-amber-900">${item.name}</h3>
                            <p class="text-xs text-gray-500 mb-1">[${item.type}]</p>
                            <p class="font-bold text-red-600 text-sm mb-2">è´¹ç”¨: Â¥${item.cost}</p>
                            <p class="text-xs text-gray-700 h-12">${item.description}</p>
                        </div>
                    `;
                });

                modalContent.innerHTML = `
                    <h2 class="game-title text-3xl text-amber-800 mb-1">æ–°è´§åˆ°äº†ï¼</h2>
                    <p class="text-gray-600 mb-4">é€‰æ‹©ä¸€ä¸ªåŠ å…¥ä½ çš„èœå•å§ï¼</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">${choicesHTML}</div>
                `;
                
                document.querySelectorAll('.choice-card:not(.disabled)').forEach(card => {
                    card.addEventListener('click', (e) => selectItem(e.currentTarget.dataset.id));
                });
            }
            
            function selectItem(id) {
                const item = {...SYMBOLS, ...PERKS}[id];
                if (gameState.revenue < item.cost) {
                    showMessage('é’±ä¸å¤Ÿï¼', 'bad');
                    return;
                }

                gameState.revenue -= item.cost;
                
                if (item.type === 'å¢ç›Š') {
                    gameState.activePerks.push(item);
                } else {
                    if (!gameState.playerSymbols.includes(id)) {
                        gameState.playerSymbols.push(id);
                    }
                }
                
                modalContainer.classList.add('hidden');
                
                if (gameState.spins <= 0) {
                    endDay();
                } else {
                    spinButton.disabled = false;
                }
                updateUI();
            }

            function updateUI() {
                dayCounter.textContent = gameState.day;
                spinsLeftDisplay.textContent = gameState.spins;
                revenueDisplay.textContent = `Â¥${Math.round(gameState.revenue)} / Â¥${gameState.goal}`;
                const currentSpinCost = Math.max(0, gameState.spinCost - (gameState.activePerks.find(p => p.id === 'chengbenjieyue') ? 1 : 0));
                spinButton.textContent = `å¼€ä¸€ç‚‰ (Â¥${currentSpinCost})`;
                
                if(gameState.revenue < gameState.goal) {
                    revenueDisplay.classList.remove('text-green-600');
                    revenueDisplay.classList.add('text-amber-900');
                } else {
                    revenueDisplay.classList.remove('text-amber-900');
                    revenueDisplay.classList.add('text-green-600');
                }

                perksList.innerHTML = gameState.activePerks.map(p => `<span class="text-2xl" title="${p.name}">${p.emoji}</span>`).join(' ');
            }

            function showMessage(msg, type = 'good') {
                messageBox.innerHTML = ''; 
                const msgElement = document.createElement('div');
                msgElement.textContent = msg;
                messageBox.appendChild(msgElement);

                messageBox.className = 'text-center h-auto min-h-[1.5rem] mb-2 font-bold transition-opacity duration-300';
                if (type === 'good') {
                    msgElement.classList.add('text-green-600');
                } else {
                    msgElement.classList.add('text-red-600', 'shake-animation');
                }
                
                messageBox.style.opacity = 1;
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                    msgElement.classList.remove('shake-animation');
                }, 1500);
            }

            spinButton.addEventListener('click', handleSpin);
            startGameButton.addEventListener('click', startGame);
        });
    </script>
</body>
</html>
